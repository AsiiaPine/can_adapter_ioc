# OpenOCD configuration for STM32G0B1 with ST-Link
# This configuration helps prevent reset issues during debugging

# Interface configuration
source [find interface/stlink.cfg]

# Target configuration
source [find target/stm32g0x.cfg]

# Override speed setting (target config sets it to 2000, but we need 1800)
adapter speed 1800

# Reset configuration
reset_config srst_only

# Enable debug output
adapter srst delay 100
adapter srst pulse_width 100

# Flash configuration for STM32G0B1
flash bank stm32g0x 0x08000000 0 0 0 $_TARGETNAME

# Debug settings
$_TARGETNAME configure -event reset-init {
    # Disable watchdog during debug
    catch { mww 0x40003000 0x0000CCCC }
    catch { mww 0x40003004 0x0000CCCC }
    
    # Reset PLL configuration to prevent HAL_RCC_OscConfig failure
    catch { mww 0x40021000 0x00000001 }  # Enable HSI
    catch { mww 0x40021004 0x00000000 }  # Clear PLLCFGR
    catch { mww 0x40021008 0x00000000 }  # Clear PLLCFGR2
    sleep 100
    
    # Configure flash latency for higher clock
    catch { mww 0x40022000 0x00000001 }  # Flash latency 1
}

# Prevent watchdog from triggering during debug
$_TARGETNAME configure -event halted {
    # Disable watchdog when halted
    catch { mww 0x40003000 0x0000CCCC }
    catch { mww 0x40003004 0x0000CCCC }
    
    # Reset PLL state when halted
    catch { mww 0x40021004 0x00000000 }  # Clear PLLCFGR
}

# Ensure target stays halted during flash operations
$_TARGETNAME configure -event gdb-flash-erase-start {
    halt
}

$_TARGETNAME configure -event gdb-flash-write-start {
    halt
}

$_TARGETNAME configure -event gdb-flash-finish {
    reset init
} 